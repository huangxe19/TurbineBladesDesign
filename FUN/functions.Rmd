---
title: "Functions"
author: "Xige Huang"
date: '2022-04-15'
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
library(R.matlab)
library(plgp)
library(ggplot2)
library(lhs)
library(laGP)
library(readr)
```


# convert design to actual scale

```{r}
convert_scale <- function(OldMax=1, OldMin=0, OldValue, NewMax, NewMin){
  OldRange = (OldMax - OldMin)  
  NewRange = (NewMax - NewMin)  
  NewValue = (((OldValue - OldMin) * NewRange) / OldRange) + NewMin
}
convert_vars <- function(oldmatrix){
  young <- mapply(convert_scale, OldValue = oldmatrix[,1], NewMax = 300e9, NewMin=200e9)
  poisson <- mapply(convert_scale, OldValue = oldmatrix[,2], NewMax = 0.1, NewMin=0.49)
  CTE <- mapply(convert_scale, OldValue = oldmatrix[,3], NewMax = 5e-6, NewMin=1.5e-5)
  thermal <- mapply(convert_scale, OldValue = oldmatrix[,4], NewMax = 5, NewMin=15)
  temp <- mapply(convert_scale, OldValue = oldmatrix[,5], NewMax = 50, NewMin=360)
  pressure <- mapply(convert_scale, OldValue = oldmatrix[,6], NewMax = 1e5, NewMin=4.8e5)
  newmatrix <- matrix(c(young, poisson, CTE, thermal, temp, pressure),
                      byrow=F, ncol=6)
return(newmatrix)
}
```

```{r}
#oldmatrix <- matrix(runif(n=4*6), ncol=6)
#test1 <- convert_vars(oldmatrix)
```


# interface between R and Matlab

```{r}
Matlab$startServer()
matlab <- Matlab()
isOpen <- open(matlab)
if (!isOpen) throw("MATLAB server is not running: waited 30 seconds.")
```

```{r}
simulator <- function(ymod = 227E9, prat = 0.27 , cte = 12.7E-6 , therm = 11.5 , ctemp = 150 ,press = 4.5E5){
  # set a variable in R and send to MATLB
  setVariable(matlab,
              ymod = ymod,
              prat = prat,
              cte = cte,
              therm = therm,
              ctemp = ctemp,
              press = press)
  
  evaluate(matlab, "[stress,displ] = simulator(ymod,prat,cte,therm,ctemp,press)")
  
  return(c(getVariable(matlab, "stress")$stress,getVariable(matlab, "displ")$displ))
}
```

```{r}
simulator()
```

```{r}
close(matlab)
```




# ALC function
```{r}
f <- function(X, sd=0.01){
  X[,1] <- (X[,1] - 0.5)*6 + 1
  X[,2] <- (X[,2] - 0.5)*6 + 1
  y <- X[,1] * exp(-X[,1]^2 - X[,2]^2) + rnorm(nrow(X), sd=sd)
}
```


```{r}
obj.alc <- function(x, gpi, Xref){
  return(- sqrt(alcGP(gpi, matrix(x, nrow=1), Xref)))
}
```

```{r}
xnp1.search <- function(X, gpi, obj=obj.alm, ...)
{
start <- mymaximin(nrow(X), 2, T=100*nrow(X), Xorig=X)
xnew <- matrix(NA, nrow=nrow(start), ncol=ncol(X) + 1)
for(i in 1:nrow(start)) {
out <- optim(start[i,], obj, method="L-BFGS-B", lower=0,
upper=1, gpi=gpi, ...)
xnew[i,] <- c(out$par, -out$value)
}
solns <- data.frame(cbind(start, xnew))
names(solns) <- c("s1", "s2", "x1", "x2", "val")
return(solns)
}
```

```{r}
mymaximin <- function(n, m, T=100000, Xorig=NULL){
  X <- matrix(runif(n*m), ncol=m) ## initial design
  d <- distance(X)
  d <- d[upper.tri(d)]
  md <- min(d)
  if(!is.null(Xorig)) { ## new code
  md2 <- min(distance(X, Xorig))
  if(md2 < md) md <- md2
  }
  for(t in 1:T) {
  row <- sample(1:n, 1)
  xold <- X[row,] ## random row selection
  X[row,] <- runif(m) ## random new row
  d <- distance(X)
  d <- d[upper.tri(d)]
  mdprime <- min(d)
  if(!is.null(Xorig)) { ## new code
  mdprime2 <- min(distance(X, Xorig))
  if(mdprime2 < mdprime) mdprime <- mdprime2
  }
  if(mdprime > md) { md <- mdprime ## accept
  } else { X[row,] <- xold } ## reject
  }
  return(X)
}
```


```{r}
ALC <- function(ninit = 12, num_para = 2, method = randomLHS, niter){
  X <- method(ninit, num_para)
  y <- f(X)
  
  x1 <- x2 <- seq(0, 1, length=niter)
  XX <- expand.grid(x1, x2)
  yytrue <- f(XX, sd=0)
  
  g <- garg(list(mle=TRUE, max=1), y)
  d <- darg(list(mle=TRUE, max=0.25), X)
  gpi <- newGP(X, y, d=d$start, g=g$start, dK=TRUE)
  mle <- jmleGP(gpi, c(d$min, d$max), c(g$min, g$max), d$ab, g$ab)
  p <- predGP(gpi, XX, lite=TRUE)
  rmse.alc <- sqrt(mean((yytrue - p$mean)^2))
  
  
  Xref <- method(niter, num_para)
  solns <- xnp1.search(X, gpi, obj=obj.alc, Xref=Xref)
  m <- which.max(solns$val)
  xnew <- as.matrix(solns[m, 3:4])
  prog.alc <- solns$val[m]
  
  X <- rbind(X, xnew)
  y <- c(y, f(xnew))
  updateGP(gpi, xnew, y[length(y)])
  mle <- rbind(mle, jmleGP(gpi, c(d$min, d$max), c(g$min, g$max),
  d$ab, g$ab))
  p <- predGP(gpi, XX, lite=TRUE)
  rmse.alc <- c(rmse.alc, sqrt(mean((yytrue - p$mean)^2)))
  
  d <- darg(list(mle=TRUE), X)
  for(i in nrow(X):(niter-1)) {
    Xref <- randomLHS(niter, num_para)
    solns <- xnp1.search(X, gpi, obj=obj.alc, Xref=Xref)
    m <- which.max(solns$val)
    prog.alc <- c(prog.alc, solns$val[m])
    xnew <- as.matrix(solns[m, 3:4])
    X <- rbind(X, xnew)
    y <- c(y, f(xnew))
    updateGP(gpi, xnew, y[length(y)])
    mle <- rbind(mle, jmleGP(gpi, c(d$min, d$max), c(g$min, g$max),
    d$ab, g$ab))
    p <- predGP(gpi, XX, lite=TRUE)
    rmse.alc <- c(rmse.alc, sqrt(mean((yytrue - p$mean)^2)))
  }
  
  return(list(X = X, y = y, rmse.alc = rmse.alc))
}
```


```{r}
res = ALC(niter = 100)
```

```{r}
par(mfrow=c(1,2))
plot(12:100, res$rmse.alc, col=2, pch=20)
```









